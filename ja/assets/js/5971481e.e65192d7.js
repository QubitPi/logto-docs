"use strict";(self.webpackChunk_logto_docs=self.webpackChunk_logto_docs||[]).push([[48563],{52020:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"authorization/api-resources/python","title":"\u30ac\u30a4\u30c9: Python","description":"\u30b9\u30c6\u30c3\u30d7 1: \u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u304b\u3089 Bearer \u30c8\u30fc\u30af\u30f3\u3092\u62bd\u51fa\u3059\u308b \\\\","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/authorization/api-resources/python.mdx","sourceDirName":"authorization/api-resources","slug":"/authorization/api-resources/python","permalink":"/ja/authorization/api-resources/python","draft":false,"unlisted":false,"editUrl":"https://github.com/logto-io/docs/tree/master/i18n/ja/docusaurus-plugin-content-docs/current/authorization/api-resources/python.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"API \u3092\u4fdd\u8b77\u3059\u308b","permalink":"/ja/authorization/api-resources/protect-your-api"},"next":{"title":"\u30ac\u30a4\u30c9: Node (Express)","permalink":"/ja/authorization/api-resources/node-express"}}');var r=o(25105),s=o(79621);const i={sidebar_position:2},a="\u30ac\u30a4\u30c9: Python",c={},d=[{value:"\u30b9\u30c6\u30c3\u30d7 1: \u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u304b\u3089 Bearer \u30c8\u30fc\u30af\u30f3\u3092\u62bd\u51fa\u3059\u308b",id:"step-1-extract-the-bearer-token-from-request-header",level:2},{value:"\u30b9\u30c6\u30c3\u30d7 2: \u30c8\u30fc\u30af\u30f3\u306e\u691c\u8a3c",id:"step-2-token-validation",level:2},{value:"<code>python-jose</code> \u3092\u4f9d\u5b58\u95a2\u4fc2\u3068\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b",id:"install-python-jose-as-your-dependency",level:3},{value:"Logto \u306e OIDC \u8a2d\u5b9a\u3092\u53d6\u5f97\u3059\u308b",id:"retrieve-logtos-oidc-configurations",level:3},{value:"\u8a8d\u53ef (Authorization) \u691c\u8a3c\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u3092\u4f5c\u6210\u3059\u308b",id:"create-the-authorization-validation-decorator",level:3},{value:"API \u306b\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u3092\u9069\u7528\u3059\u308b",id:"apply-decorator-to-your-api",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u30ac\u30a4\u30c9-python",children:"\u30ac\u30a4\u30c9: Python"})}),"\n",(0,r.jsx)(n.h2,{id:"step-1-extract-the-bearer-token-from-request-header",children:"\u30b9\u30c6\u30c3\u30d7 1: \u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u304b\u3089 Bearer \u30c8\u30fc\u30af\u30f3\u3092\u62bd\u51fa\u3059\u308b"}),"\n",(0,r.jsxs)(n.p,{children:["\u8a8d\u53ef\u3055\u308c\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u306f\u3001",(0,r.jsx)(n.code,{children:"Bearer <\u30a2\u30af\u30bb\u30b9 \u30c8\u30fc\u30af\u30f3>"})," \u3092\u5185\u5bb9\u3068\u3059\u308b ",(0,r.jsx)(n.code,{children:"Authorization"})," \u30d8\u30c3\u30c0\u30fc\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u304b\u3089\u8a8d\u53ef\u30c8\u30fc\u30af\u30f3\u3092\u62bd\u51fa\u3057\u307e\u3059\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\"\"\"requires-auth.py\n\"\"\"\ndef get_auth_token():\n  auth = request.headers.get(\"Authorization\", None)\n\n  if not auth:\n    raise Error({ code: 'auth.authorization_header_missing', status: 401 })\n\n  contents = auth.split()\n\n  if len(contents) < 2:\n    raise Error({code: 'auth.authorization_token_invalid_format', status: 401})\n\n  elif contents[0] != 'Bearer':\n    raise Error({code: 'auth.authorization_token_type_not_supported', status: 401})\n\n  return contents[1]\n"})}),"\n",(0,r.jsx)(n.h2,{id:"step-2-token-validation",children:"\u30b9\u30c6\u30c3\u30d7 2: \u30c8\u30fc\u30af\u30f3\u306e\u691c\u8a3c"}),"\n",(0,r.jsxs)(n.p,{children:["\u30c7\u30e2\u30f3\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u305f\u3081\u306b\u3001Flask \u30a2\u30d7\u30ea\u3068 ",(0,r.jsx)(n.a,{href:"https://github.com/mpdavis/python-jose",children:"jose"})," \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u7528\u3057\u3066\u3001\u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3001\u6709\u52b9\u671f\u9650\u3001\u304a\u3088\u3073\u5fc5\u8981\u306a\u30af\u30ec\u30fc\u30e0\u3092\u691c\u8a3c\u3059\u308b require_auth \u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsxs)(n.h3,{id:"install-python-jose-as-your-dependency",children:[(0,r.jsx)(n.code,{children:"python-jose"})," \u3092\u4f9d\u5b58\u95a2\u4fc2\u3068\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b"]}),"\n",(0,r.jsxs)(n.p,{children:["Logto \u3067\u4f7f\u7528\u3057\u3066\u3044\u308b\u6697\u53f7\u5316\u65b9\u5f0f\u3092\u9078\u629e\u3057\u307e\u3059\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f ",(0,r.jsx)(n.code,{children:"ecdsa"}),"\uff09\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"pip install python-jose[ecdsa]\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"retrieve-logtos-oidc-configurations",children:"Logto \u306e OIDC \u8a2d\u5b9a\u3092\u53d6\u5f97\u3059\u308b"}),"\n",(0,r.jsxs)(n.p,{children:["\u53d7\u4fe1\u3057\u305f JWS \u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3068\u30bd\u30fc\u30b9\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306b\u3001JWK \u516c\u958b\u9375\u30bb\u30c3\u30c8\u3068\u30c8\u30fc\u30af\u30f3\u767a\u884c\u8005\u304c\u5fc5\u8981\u3067\u3059\u3002\u6700\u65b0\u306e Logto \u8a8d\u53ef (Authorization) \u8a2d\u5b9a\u306f\u3059\u3079\u3066 ",(0,r.jsx)(n.code,{children:"https://<your-logto-domain>/oidc/.well-known/openid-configuration"})," \u3067\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f8b\uff1a",(0,r.jsx)(n.code,{children:"https://tenant-id.logto.app/oidc/.well-known/openid-configuration"})," \u3092\u547c\u3073\u51fa\u3057\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u30dc\u30c7\u30a3\u5185\u306e\u6b21\u306e 2 \u3064\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u898b\u3064\u3051\u307e\u3059\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "jwks_uri": "https://tenant-id.logto.app/oidc/jwks",\n  "issuer": "https://tenant-id.logto.app/oidc"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"create-the-authorization-validation-decorator",children:"\u8a8d\u53ef (Authorization) \u691c\u8a3c\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u3092\u4f5c\u6210\u3059\u308b"}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/authorization/role-based-access-control/protect-api-resources-with-rbac",children:"\u30ed\u30fc\u30eb\u30d9\u30fc\u30b9\u306e\u30a2\u30af\u30bb\u30b9\u5236\u5fa1 (RBAC)"})," \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001\u30b9\u30b3\u30fc\u30d7\u306e\u691c\u8a3c\u3082\u5fc5\u8981\u3067\u3059\u3002"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\"\"\"requires-auth.py\n\"\"\"\n\nimport json\nfrom flask import request,  _request_ctx_stack\nfrom six.moves.urllib.request import urlopen\nfrom functools import wraps\nfrom jose import jwt\n\ndef requires_auth(f):\n  @wraps(f)\n  def decorated(*args, **kwargs):\n    token = get_token_auth_header()\n\n# Logto \u304b\u3089\u53d6\u5f97\u3057\u305f jwks_uri \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\n    jwks_uri = urlopen('https://<your-logto-domain>/oidc/jwks')\n\n# Logto \u304b\u3089\u53d6\u5f97\u3057\u305f\u767a\u884c\u8005\n    issuer = 'https://<your-logto-domain>/oidc'\n\n    jwks = json.loads(jwks_uri.read())\n\n    try:\n      payload = jwt.decode(\n        token,\n        jwks,\n# jwks \u3068\u5171\u306b\u53d6\u5f97\u3057\u305f jwt \u30a8\u30f3\u30b3\u30fc\u30c9\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f ES384\n        algorithms=jwt.get_unverified_header(token).get('alg'),\n# Logto \u306b\u767b\u9332\u3055\u308c\u305f API \u306e\u30ea\u30bd\u30fc\u30b9\u30a4\u30f3\u30b8\u30b1\u30fc\u30bf\u30fc\n        audience='<your request listener resource indicator>',\n        issuer=issuer,\n        options={\n          'verify_at_hash': False\n        }\n      )\n    except Exception:\n# \u4f8b\u5916\u30cf\u30f3\u30c9\u30e9\u30fc\n      raise Error({code: 'invalid_token', status: 401})\n\n# \u30da\u30a4\u30ed\u30fc\u30c9\u3092\u51e6\u7406\u3059\u308b\u30ab\u30b9\u30bf\u30e0\u30b3\u30fc\u30c9\n    _request_ctx_stack.top.user_id = payload.get('sub')\n\n    return f(*args, **kwargs)\n  return decorated\n"})}),"\n",(0,r.jsx)(n.h2,{id:"apply-decorator-to-your-api",children:"API \u306b\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u3092\u9069\u7528\u3059\u308b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from flask import Flask\nfrom flask_cors import cross_origin\n\nAPP = Flask(__name__)\n\n@APP.route("/user/info")\n@cross_origin(headers=["Content-Type", "Authorization"])\n@requires_auth\ndef api:\n# \u3042\u306a\u305f\u306e API \u30ed\u30b8\u30c3\u30af\n'})})]})}function l(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},79621:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>a});var t=o(58101);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);