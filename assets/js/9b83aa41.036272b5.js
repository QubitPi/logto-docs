"use strict";(self.webpackChunk_logto_docs=self.webpackChunk_logto_docs||[]).push([[21174],{99475:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"authorization/api-resources/node-express","title":"Guide: Node (Express)","description":"Step 1: Extract the Bearer Token from request header \\\\","source":"@site/docs/authorization/api-resources/node-express.mdx","sourceDirName":"authorization/api-resources","slug":"/authorization/api-resources/node-express","permalink":"/authorization/api-resources/node-express","draft":false,"unlisted":false,"editUrl":"https://github.com/logto-io/docs/tree/master/docs/authorization/api-resources/node-express.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docsSidebar","previous":{"title":"Guide: Python","permalink":"/authorization/api-resources/python"},"next":{"title":"Guide: Spring Boot","permalink":"/authorization/api-resources/spring-boot"}}');var n=o(25105),s=o(79621);const i={sidebar_position:3},a="Guide: Node (Express)",d={},c=[{value:"Step 1: Extract the Bearer Token from request header",id:"step-1-extract-the-bearer-token-from-request-header",level:2},{value:"Step 2: Token validation",id:"step-2-token-validation",level:2},{value:"Install <code>jose</code> as your dependency",id:"install-jose-as-your-dependency",level:3},{value:"Retrieve Logto&#39;s OIDC configurations",id:"retrieve-logtos-oidc-configurations",level:3},{value:"Add auth middleware",id:"add-auth-middleware",level:3},{value:"Apply middleware to your API",id:"apply-middleware-to-your-api",level:2},{value:"Related resources",id:"related-resources",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components},{Url:o}=t;return o||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Url",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"guide-node-express",children:"Guide: Node (Express)"})}),"\n",(0,n.jsx)(t.h2,{id:"step-1-extract-the-bearer-token-from-request-header",children:"Step 1: Extract the Bearer Token from request header"}),"\n",(0,n.jsxs)(t.p,{children:["A authorized request should contain an ",(0,n.jsx)(t.code,{children:"Authorization"})," header with ",(0,n.jsx)(t.code,{children:"Bearer <access_token>"})," as its content. Extract the Authorization Token from the request header:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-tsx",children:"// auth_middleware.ts\n\nimport { IncomingHttpHeaders } from 'http';\n\nconst extractBearerTokenFromHeaders = ({ authorization }: IncomingHttpHeaders) => {\n  const bearerTokenIdentifier = 'Bearer';\n\n  if (!authorization) {\n    throw new Error({ code: 'auth.authorization_header_missing', status: 401 });\n  }\n\n  if (!authorization.startsWith(bearerTokenIdentifier)) {\n    throw new Error({ code: 'auth.authorization_token_type_not_supported', status: 401 });\n  }\n\n  return authorization.slice(bearerTokenIdentifier.length + 1);\n};\n"})}),"\n",(0,n.jsx)(t.h2,{id:"step-2-token-validation",children:"Step 2: Token validation"}),"\n",(0,n.jsxs)(t.p,{children:["For demonstration, we use ",(0,n.jsx)(t.a,{href:"https://github.com/panva/jose",children:"jose"})," package to validate the token's signature, expiration status, and required claims."]}),"\n",(0,n.jsxs)(t.h3,{id:"install-jose-as-your-dependency",children:["Install ",(0,n.jsx)(t.code,{children:"jose"})," as your dependency"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"npm i jose --save\n"})}),"\n",(0,n.jsx)(t.h3,{id:"retrieve-logtos-oidc-configurations",children:"Retrieve Logto's OIDC configurations"}),"\n",(0,n.jsxs)(t.p,{children:["You will need a JWK public key set and the token issuer to verify the signature and source of the received JWS token. All the latest public Logto Authorization Configurations can be found at ",(0,n.jsx)(t.code,{children:"https://<your-logto-domain>/oidc/.well-known/openid-configuration"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["e.g. Call ",(0,n.jsx)(t.code,{children:"https://tenant-id.logto.app/oidc/.well-known/openid-configuration"}),". And locate the following two fields in the response body:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "jwks_uri": "https://tenant-id.logto.app/oidc/jwks",\n  "issuer": "https://tenant-id.logto.app/oidc"\n}\n'})}),"\n",(0,n.jsx)(t.h3,{id:"add-auth-middleware",children:"Add auth middleware"}),"\n",(0,n.jsxs)(t.p,{children:["Jose's ",(0,n.jsx)(t.code,{children:"jwtVerify"})," method may helps you to verify the token's JWS format, token signature, issuer, audience and the expiration status. A exception will be thrown if validation failed."]}),"\n",(0,n.jsx)(t.admonition,{type:"warning",children:(0,n.jsxs)(t.p,{children:["If you use ",(0,n.jsx)(t.a,{href:"/authorization/role-based-access-control/protect-api-resources-with-rbac",children:"Role-based access control"}),", scope validation is also required."]})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-tsx",children:"// auth-middleware.ts\n\nimport { createRemoteJWKSet, jwtVerify } from 'jose';\n\n//...\n\nexport const verifyAuthFromRequest = async (req, res, next) => {\n  // Extract the token\n  const token = extractBearerTokenFromHeaders(req.headers);\n\n  const { payload } = await jwtVerify(\n    token, // The raw Bearer Token extracted from the request header\n    createRemoteJWKSet(new URL('https://<your-logto-domain>/oidc/jwks')), // generate a jwks using jwks_uri inquired from Logto server\n    {\n      // expected issuer of the token, should be issued by the Logto server\n      issuer: 'https://<your-logto-domain>/oidc',\n      // expected audience token, should be the resource indicator of the current API\n      audience: '<your request listener resource indicator>',\n    }\n  );\n\n  // if you are using RBAC\n  assert(payload.scope.includes('some_scope'));\n\n  // custom payload logic\n  userId = payload.sub;\n\n  return next();\n};\n"})}),"\n",(0,n.jsx)(t.h2,{id:"apply-middleware-to-your-api",children:"Apply middleware to your API"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-tsx",children:"import { verifyAuthFromRequest } from '/middleware/auth-middleware.ts';\n\napp.get('/user/:id', verifyAuthFromRequest, (req, res, next) => {\n  // Custom code\n});\n"})}),"\n",(0,n.jsx)(t.h2,{id:"related-resources",children:"Related resources"}),"\n",(0,n.jsx)(o,{href:"https://blog.logto.io/protect-your-express-js-api",children:(0,n.jsx)(t.p,{children:"Protect your Express.js API with JWT and Logto"})})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},79621:(e,t,o)=>{o.d(t,{R:()=>i,x:()=>a});var r=o(58101);const n={},s=r.createContext(n);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);