"use strict";(self.webpackChunk_logto_docs=self.webpackChunk_logto_docs||[]).push([[33631],{98803:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"authorization/api-resources/python","title":"\u6307\u5357\uff1aPython","description":"\u7b2c\u4e00\u6b65\uff1a\u4ece\u8bf7\u6c42\u5934\u4e2d\u63d0\u53d6 Bearer \u4ee4\u724c \\\\","source":"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/authorization/api-resources/python.mdx","sourceDirName":"authorization/api-resources","slug":"/authorization/api-resources/python","permalink":"/zh-CN/authorization/api-resources/python","draft":false,"unlisted":false,"editUrl":"https://github.com/logto-io/docs/tree/master/i18n/zh-CN/docusaurus-plugin-content-docs/current/authorization/api-resources/python.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"\u4fdd\u62a4\u4f60\u7684 API","permalink":"/zh-CN/authorization/api-resources/protect-your-api"},"next":{"title":"\u6307\u5357\uff1aNode (Express)","permalink":"/zh-CN/authorization/api-resources/node-express"}}');var r=o(25105),s=o(79621);const i={sidebar_position:2},a="\u6307\u5357\uff1aPython",c={},d=[{value:"\u7b2c\u4e00\u6b65\uff1a\u4ece\u8bf7\u6c42\u5934\u4e2d\u63d0\u53d6 Bearer \u4ee4\u724c",id:"step-1-extract-the-bearer-token-from-request-header",level:2},{value:"\u7b2c\u4e8c\u6b65\uff1a\u4ee4\u724c\u9a8c\u8bc1",id:"step-2-token-validation",level:2},{value:"\u5b89\u88c5 <code>python-jose</code> \u4f5c\u4e3a\u4f60\u7684\u4f9d\u8d56",id:"install-python-jose-as-your-dependency",level:3},{value:"\u83b7\u53d6 Logto \u7684 OIDC \u914d\u7f6e",id:"retrieve-logtos-oidc-configurations",level:3},{value:"\u521b\u5efa\u6388\u6743\u9a8c\u8bc1\u88c5\u9970\u5668",id:"create-the-authorization-validation-decorator",level:3},{value:"\u5c06\u88c5\u9970\u5668\u5e94\u7528\u4e8e\u4f60\u7684 API",id:"apply-decorator-to-your-api",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u6307\u5357python",children:"\u6307\u5357\uff1aPython"})}),"\n",(0,r.jsx)(n.h2,{id:"step-1-extract-the-bearer-token-from-request-header",children:"\u7b2c\u4e00\u6b65\uff1a\u4ece\u8bf7\u6c42\u5934\u4e2d\u63d0\u53d6 Bearer \u4ee4\u724c"}),"\n",(0,r.jsxs)(n.p,{children:["\u4e00\u4e2a\u6388\u6743\u8bf7\u6c42\u5e94\u8be5\u5305\u542b\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"Authorization"})," \u5934\uff0c\u5176\u5185\u5bb9\u4e3a ",(0,r.jsx)(n.code,{children:"Bearer <access_token>"}),"\u3002\u4ece\u8bf7\u6c42\u5934\u4e2d\u63d0\u53d6\u6388\u6743\u4ee4\u724c (Authorization token)\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\"\"\"requires-auth.py\n\"\"\"\ndef get_auth_token():\n  auth = request.headers.get(\"Authorization\", None)\n\n  if not auth:\n    raise Error({ code: 'auth.authorization_header_missing', status: 401 })\n\n  contents = auth.split()\n\n  if len(contents) < 2\n    raise Error({code: 'auth.authorization_token_invalid_format', status: 401})\n\n  elif contents[0] != 'Bearer'\n    raise Error({code: 'auth.authorization_token_type_not_supported', status: 401})\n\n  return contents[1]\n"})}),"\n",(0,r.jsx)(n.h2,{id:"step-2-token-validation",children:"\u7b2c\u4e8c\u6b65\uff1a\u4ee4\u724c\u9a8c\u8bc1"}),"\n",(0,r.jsxs)(n.p,{children:["\u4e3a\u4e86\u6f14\u793a\uff0c\u6211\u4eec\u4f7f\u7528 Flask \u5e94\u7528\u548c ",(0,r.jsx)(n.a,{href:"https://github.com/mpdavis/python-jose",children:"jose"})," \u5305\u6765\u521b\u5efa require_auth \u88c5\u9970\u5668\uff0c\u4ee5\u9a8c\u8bc1\u4ee4\u724c\u7684\u7b7e\u540d\u3001\u8fc7\u671f\u72b6\u6001\u548c\u6240\u9700\u58f0\u660e (Claims)\u3002"]}),"\n",(0,r.jsxs)(n.h3,{id:"install-python-jose-as-your-dependency",children:["\u5b89\u88c5 ",(0,r.jsx)(n.code,{children:"python-jose"})," \u4f5c\u4e3a\u4f60\u7684\u4f9d\u8d56"]}),"\n",(0,r.jsxs)(n.p,{children:["\u9009\u62e9\u4f60\u5728 Logto \u4e2d\u4f7f\u7528\u7684\u52a0\u5bc6\u7b97\u6cd5\u3002\uff08\u9ed8\u8ba4\u662f ",(0,r.jsx)(n.code,{children:"ecdsa"}),"\uff09"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"pip install python-jose[ecdsa]\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"retrieve-logtos-oidc-configurations",children:"\u83b7\u53d6 Logto \u7684 OIDC \u914d\u7f6e"}),"\n",(0,r.jsxs)(n.p,{children:["\u4f60\u5c06\u9700\u8981\u4e00\u4e2a JWK \u516c\u94a5\u96c6\u548c\u4ee4\u724c\u53d1\u884c\u8005 (Issuer) \u6765\u9a8c\u8bc1\u63a5\u6536\u5230\u7684 JWS \u4ee4\u724c\u7684\u7b7e\u540d\u548c\u6765\u6e90\u3002\u6240\u6709\u6700\u65b0\u7684 Logto \u6388\u6743\u914d\u7f6e\u53ef\u4ee5\u5728 ",(0,r.jsx)(n.code,{children:"https://<your-logto-domain>/oidc/.well-known/openid-configuration"})," \u627e\u5230\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f8b\u5982\uff0c\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"https://tenant-id.logto.app/oidc/.well-known/openid-configuration"}),"\u3002\u5e76\u5728\u54cd\u5e94\u4f53\u4e2d\u627e\u5230\u4ee5\u4e0b\u4e24\u4e2a\u5b57\u6bb5\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "jwks_uri": "https://tenant-id.logto.app/oidc/jwks",\n  "issuer": "https://tenant-id.logto.app/oidc"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"create-the-authorization-validation-decorator",children:"\u521b\u5efa\u6388\u6743\u9a8c\u8bc1\u88c5\u9970\u5668"}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["\u5982\u679c\u4f60\u4f7f\u7528 ",(0,r.jsx)(n.a,{href:"/authorization/role-based-access-control/protect-api-resources-with-rbac",children:"\u57fa\u4e8e\u89d2\u8272\u7684\u8bbf\u95ee\u63a7\u5236 (RBAC)"}),"\uff0c\u8fd8\u9700\u8981\u8fdb\u884c\u6743\u9650 (Scope) \u9a8c\u8bc1\u3002"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"\"\"\"requires-auth.py\n\"\"\"\n\nimport json\nfrom flask import request,  _request_ctx_stack\nfrom six.moves.urllib.request import urlopen\nfrom functools import wraps\nfrom jose import jwt\n\ndef requires_auth(f):\n  @wraps(f)\n  def decorated(*args, **kwargs):\n    token = get_token_auth_header()\n\n# \u4ece Logto \u83b7\u53d6\u7684 jwks_uri \u7aef\u70b9\n    jwks_uri = urlopen('https://<your-logto-domain>/oidc/jwks')\n\n# \u4ece Logto \u83b7\u53d6\u7684\u53d1\u884c\u8005 (Issuer)\n    issuer = 'https://<your-logto-domain>/oidc'\n\n    jwks = json.loads(jwks_uri.read())\n\n    try:\n      payload = jwt.decode(\n        token,\n        jwks,\n# \u4e0e jwks \u4e00\u8d77\u68c0\u7d22\u5230\u7684 jwt \u7f16\u7801\u7b97\u6cd5\u3002\u9ed8\u8ba4\u662f ES384\n        algorithms=jwt.get_unverified_header(token).get('alg'),\n# \u5728 Logto \u4e2d\u6ce8\u518c\u7684 API \u7684\u8d44\u6e90\u6307\u793a\u5668\n        audience='<your request listener resource indicator>',\n        issuer=issuer,\n        options={\n          'verify_at_hash': False\n        }\n      )\n    except Exception:\n# \u5f02\u5e38\u5904\u7406\u7a0b\u5e8f\n      raise Error({code: 'invalid_token', status: 401})\n\n# \u5904\u7406 payload \u7684\u81ea\u5b9a\u4e49\u4ee3\u7801\n    _request_ctx_stack.top.user_id = payload.get('sub')\n\n    return f(*args, **kwargs)\n  return decorated\n"})}),"\n",(0,r.jsx)(n.h2,{id:"apply-decorator-to-your-api",children:"\u5c06\u88c5\u9970\u5668\u5e94\u7528\u4e8e\u4f60\u7684 API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from flask import Flask\nfrom flask_cors import cross_origin\n\nAPP = Flask(__name__)\n\n@APP.route("/user/info")\n@cross_origin(headers=["Content-Type", "Authorization"])\n@requires_auth\ndef api:\n# \u4f60\u7684 API \u903b\u8f91\n'})})]})}function l(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},79621:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>a});var t=o(58101);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);