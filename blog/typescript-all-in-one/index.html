<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">TypeScript all-in-one: Monorepo with its pains and gains | Logto Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://QubitPi.github.io/logto-docs/blog/typescript-all-in-one/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="TypeScript all-in-one: Monorepo with its pains and gains | Logto Docs"><meta data-rh="true" name="description" content="Intro"><meta data-rh="true" property="og:description" content="Intro"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-08-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/gao-sun"><meta data-rh="true" property="article:tag" content="typescript,monorepo"><link data-rh="true" rel="icon" href="/logto-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://QubitPi.github.io/logto-docs/blog/typescript-all-in-one/"><link data-rh="true" rel="alternate" href="https://QubitPi.github.io/logto-docs/blog/typescript-all-in-one/" hreflang="en"><link data-rh="true" rel="alternate" href="https://QubitPi.github.io/logto-docs/blog/typescript-all-in-one/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://DE7QZWOVO6-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/logto-docs/blog/rss.xml" title="Logto Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/logto-docs/blog/atom.xml" title="Logto Docs Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Logto Docs" href="/logto-docs/opensearch.xml">

<script src="https://plausible.io/js/plausible.js" defer="defer" data-domain="docs.logto.io"></script>
<meta name="google-site-verification" content="3EYzsnarDwG6zL2dlHvyC8ySVcV6Q3RGlvh7-bvhb2k">

<link rel="alternate" type="application/rss+xml" href="/logto-docs/tutorial/rss.xml" title="Logto Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/logto-docs/tutorial/atom.xml" title="Logto Docs Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/logto-docs/terms/rss.xml" title="Logto Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/logto-docs/terms/atom.xml" title="Logto Docs Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/logto-docs/about/rss.xml" title="Logto Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/logto-docs/about/atom.xml" title="Logto Docs Atom Feed"><link rel="stylesheet" href="/logto-docs/assets/css/styles.3b00d7af.css">
<link rel="preload" href="/logto-docs/assets/js/runtime~main.cc33f748.js" as="script">
<link rel="preload" href="/logto-docs/assets/js/main.777d428a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_osaM" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://logto.io" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/logto-docs/img/logto.svg" alt="Silverhand Logo" class="themedImage_wElh themedImage--light_oONo"><img src="/logto-docs/img/logto_dark.svg" alt="Silverhand Logo" class="themedImage_wElh themedImage--dark_ZDYX"></div></a><a class="navbar__item navbar__link" href="/logto-docs/">Docs</a><a href="https://blog.logto.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_JOi6"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/logto-docs/sdk/">SDK</a><a href="https://openapi.logto.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/logto-docs/">1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/logto-docs/next/">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/logto-docs/">1.x</a></li></ul></div><a href="https://github.com/logto-io/logto" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_JOi6"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_OMoR colorModeToggle_KUCu"><button class="clean-btn toggleButton_qHjk toggleButtonDisabled_v3Sq" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_gi9X"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qbA8"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ygvZ"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_f_zb"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><div class="container_Zhex margin-vert--md"><time datetime="2022-08-07T00:00:00.000Z" itemprop="datePublished">August 7, 2022</time> Â· <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SwtP"><div class="avatar margin-bottom--sm"><a href="https://github.com/gao-sun" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/gao-sun.png" alt="Gao"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/gao-sun" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Gao</span></a></div><small class="avatar__subtitle" itemprop="description">Founder of Silverhand</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="intro">Intro<a href="#intro" class="hash-link" aria-label="Direct link to Intro" title="Direct link to Intro">â</a></h2><p>I always had a dream of monorepo.</p><p>I saw the monorepo approach while working for Airbnb, but it was for the frontend only. With a deep love of the JavaScript ecosystem and the âhappyâ TypeScript developing experience, I started to align frontend and backend code in the same language from ~three years ago. It was great (for hiring) but not that great for developing since our projects were still scattered across multiple repos.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_zpDR"><div class="admonitionHeading_iYwg"><span class="admonitionIcon_GPu2"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>FYI</div><div class="admonitionContent_AHia"><p>There are quotes around the word âhappyâ since TypeScript did bring me a lot of fun and a-ha moments, but it also let me think âhow could this doesnât workâ sometimes.</p></div></div><p>As it says, âthe best way of refactoring a project is to start a new oneâ. So when I was starting my startup about one year ago, I decided to use a total monorepo strategy: put frontend and backend projects, even database schemas, into one repo.</p><p>In this article, I wonât compare monorepo and polyrepo since itâs all about philosophy. Instead, Iâll focus on the building and evolving experience and assume you are familiar with the JS/TS ecosystem.</p><p>The final result is available on <a href="https://github.com/logto-io/logto" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="why-typescript">Why TypeScript?<a href="#why-typescript" class="hash-link" aria-label="Direct link to Why TypeScript?" title="Direct link to Why TypeScript?">â</a></h2><p>Frankly speaking, Iâm a fan of JavaScript and TypeScript. I love the compatibility of its flexibility and rigorousness: you can fall back to <code>unknown</code> or <code>any</code> (although we banned any form of <code>any</code> in our codebase), or use a super-strict lint rule set to align the code style across the team.</p><p>When we were talking about the concept of âfullstackâ before, we usually imagine at least two ecosystems and programming languages: one for frontend and one for backend.</p><p>One day, I suddenly realized it could be simpler: Node.js is fast enough (believe me, in most cases, code quality is more important than running speed), TypeScript is mature enough (works well in big frontend projects), and the monorepo concept has been practiced by a bunch of famous teams (React, Babel, etc.) - so why donât we combine all the code together, from frontend to backend? This can make engineers do the jobs without context switch in one repo and implement a complete feature in (almost) one language.</p><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="choosing-package-manager">Choosing package manager<a href="#choosing-package-manager" class="hash-link" aria-label="Direct link to Choosing package manager" title="Direct link to Choosing package manager">â</a></h2><p>As a developer, and as usual, I couldnât wait to start coding. But this time, things were different.</p><p>The choice of the package manager is critical to the dev experience in a monorepo.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_zpDR"><div class="admonitionHeading_iYwg"><span class="admonitionIcon_GPu2"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>ð¨ TL; DR</div><div class="admonitionContent_AHia"><p>We chose lerna with pnpm.</p></div></div><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="the-pain-of-inertia">The pain of inertia<a href="#the-pain-of-inertia" class="hash-link" aria-label="Direct link to The pain of inertia" title="Direct link to The pain of inertia">â</a></h3><p>It was July 2021. I started with <code>yarn@1.x</code> since Iâve been using it for a long time. Yarn was fast, but soon I met several issues with Yarn Workspaces. E.g., <a href="https://github.com/yarnpkg/yarn/issues/7572" target="_blank" rel="noopener noreferrer">not hoisting dependencies correctly</a>, and tons of issues are tagged with â<a href="https://github.com/yarnpkg/yarn/issues?q=label%3Afixed-in-modern+" target="_blank" rel="noopener noreferrer">fixed in modern</a>â, which redirects me to the v2 (<a href="https://github.com/yarnpkg/berry" target="_blank" rel="noopener noreferrer">berry</a>).</p><p>âOkay fine Iâm upgrading now.â I stopped struggling with v1 and started to migrate. But the long <a href="https://yarnpkg.com/getting-started/migration" target="_blank" rel="noopener noreferrer">migration guide</a> of berry frightened me, and I gave up after several failed tries.</p><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="it-just-works">It just works<a href="#it-just-works" class="hash-link" aria-label="Direct link to It just works" title="Direct link to It just works">â</a></h3><p>So the research about package managers began. I was absorbed by <code>pnpm</code> after a trial: fast as yarn, native monorepo support, similar commands to <code>npm</code>, hard links, etc. Most importantly, it just works. As a developer who wants to get started with a product but NOT develop a package manager, I just wanted to add some dependencies and start the project without knowing how a package manager works or any other fancy concepts.</p><p>Based on the same idea, we chose an old friend <code>lerna</code> for executing commands across the packages and publishing workspace packages.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_zpDR"><div class="admonitionHeading_iYwg"><span class="admonitionIcon_GPu2"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_AHia"><p>Now pnpm has a -w option to run commands in the workspace root and --filter for filtering. Thus you can probably replace lerna with a more dedicated package publishing CLI.</p></div></div><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="defining-package-scopes">Defining package scopes<a href="#defining-package-scopes" class="hash-link" aria-label="Direct link to Defining package scopes" title="Direct link to Defining package scopes">â</a></h2><p>Itâs hard to clearly figure out the final scope of each package in the beginning. Just start with your best try according to the status quo, and remember you can always refactor during development.</p><p>Our <a href="https://github.com/logto-io/logto/tree/af7e6ccd83723d623555dafa4650e115fa795838/packages" target="_blank" rel="noopener noreferrer">initial structure</a> contains four packages:</p><ul><li><code>core</code>: the backend monolith service.</li><li><code>phrases</code>: i18n key â phrase resources.</li><li><code>schemas</code>: the database and shared TypeScript schemas.</li><li><code>ui</code>: a web SPA that interacts with <code>core</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="tech-stack-for-fullstack">Tech stack for fullstack<a href="#tech-stack-for-fullstack" class="hash-link" aria-label="Direct link to Tech stack for fullstack" title="Direct link to Tech stack for fullstack">â</a></h2><p>Since we are embracing the JavaScript ecosystem and using TypeScript as our main programming language, a lot of choices are straightforward (based on my preference ð):</p><ul><li><code>koajs</code> for the backend service (core): I had a hard experience using <code>async/await</code> in <code>express</code>, so I decided to use something with native support.</li><li><code>i18next/react-i18next</code> for i18n (phrases/ui): like its simplicity of APIs and good TypeScript support.</li><li><code>react</code> for SPA (ui): Just personal preference.</li></ul><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="how-about-schemas">How about schemas?<a href="#how-about-schemas" class="hash-link" aria-label="Direct link to How about schemas?" title="Direct link to How about schemas?">â</a></h3><p>Something is still missing here: database system and schema &lt;-&gt; TypeScript definition mapping.</p><h4 class="anchor anchorWithStickyNavbar_E7Z_" id="general-vs-opinionated">General v.s. opinionated<a href="#general-vs-opinionated" class="hash-link" aria-label="Direct link to General v.s. opinionated" title="Direct link to General v.s. opinionated">â</a></h4><p>At that point, I tried two popular approaches:</p><ul><li>Use ORM with a lot of decorators.</li><li>Use a query builder like Knex.js.</li></ul><p>But both of them produce a strange feeling during previous development:</p><ul><li>For ORM: Iâm not a fan of decorators, and another abstract layer of the database causes more learning effort and uncertainty for the team.</li><li>For query builder: Itâs like writing SQL with some restrictions (in a good way), but itâs not actual SQL. Thus we need to use <code>.raw()</code> for raw queries in many scenarios.</li></ul><p>Then I saw this article: â<a href="https://gajus.medium.com/stop-using-knex-js-and-earn-30-bf410349856c" target="_blank" rel="noopener noreferrer">Stop using Knex.js: Using SQL query builder is an anti-pattern</a>â. The title looks aggressive, but the content is great. It strongly reminds me that âSQL is a programming languageâ, and I realized I could write SQL directly (just like CSS, how could I miss this!) to leverage the native language and database features instead of adding another layer and reducing the power.</p><p>In conclusion, I decided to stick with Postgres and <a href="https://github.com/gajus/slonik" target="_blank" rel="noopener noreferrer">Slonik</a> (an open-source Postgres client), as the article states:</p><blockquote><p>â¦the benefit of allowing user to choose between the different database dialects is marginal and the overhead of developing for multiple databases at once is significant.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_E7Z_" id="sql---typescript">SQL &lt;-&gt; TypeScript<a href="#sql---typescript" class="hash-link" aria-label="Direct link to SQL &lt;-&gt; TypeScript" title="Direct link to SQL &lt;-&gt; TypeScript">â</a></h4><p>Another advantage of writing SQL is we can easily use it as the single source of truth of TypeScript definitions. I wrote a <a href="https://github.com/logto-io/logto/tree/af7e6ccd83723d623555dafa4650e115fa795838/packages/schemas/src/gen" target="_blank" rel="noopener noreferrer">code generator</a> to transpile SQL schemas to TypeScript code that weâll use in our backend, and the result looks not bad:</p><div class="language-tsx codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-tsx codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">OidcClientMetadata</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;../foundations&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">OidcClient</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">OidcClientMetadata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can even connect <code>jsonb</code> with a TypeScript type and process type validation in the backend service if needed.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_zpDR"><div class="admonitionHeading_iYwg"><span class="admonitionIcon_GPu2"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>ð¤ Why not use TypeScript as the SSOT?</div><div class="admonitionContent_AHia"><p>Itâs a plan Iâve thought of. It sounds attractive initially, but SQL will precisely describe database schemas and keep the flow in one direction (see the following section) instead of using TypeScript and then âtranspile backâ to SQL.</p></div></div><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">â</a></h3><p>The final dependency structure looks like:</p><p>You may notice itâs a one-direction diagram, which greatly helped us to keep a clear architecture and the ability to expand while the project grows. Plus, the code is (basically) all in TypeScript.</p><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="dev-experience">Dev experience<a href="#dev-experience" class="hash-link" aria-label="Direct link to Dev experience" title="Direct link to Dev experience">â</a></h2><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="package-and-config-sharing">Package and config sharing<a href="#package-and-config-sharing" class="hash-link" aria-label="Direct link to Package and config sharing" title="Direct link to Package and config sharing">â</a></h3><h4 class="anchor anchorWithStickyNavbar_E7Z_" id="internal-dependencies">Internal dependencies<a href="#internal-dependencies" class="hash-link" aria-label="Direct link to Internal dependencies" title="Direct link to Internal dependencies">â</a></h4><p><code>pnpm</code> and <code>lerna</code> are doing an awesome job on internal workspace dependencies. We use the command below in the project root to add sibling packages:</p><div class="language-bash codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-bash codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token plain">lerna </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> --scope</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">@logto/core @logto/schemas</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will add <code>@logto/schemas</code> as a dependency to <code>@logto/core</code>. While keeping the semantic version in <code>package.json</code> of your internal dependencies, <code>pnpm</code> can also correctly link them in <code>pnpm-lock.yaml</code>. The result will look like this:</p><div class="language-json codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-json codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// packages/core/pacakge.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;dependencies&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;@logto/schemas&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;^1.0.0-beta.3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-yaml codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-yaml codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># pnpm-lock.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">packages/core</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dependencies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&#x27;@logto/schemas&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> link</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">../schemas</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_E7Z_" id="config-sharing">Config sharing<a href="#config-sharing" class="hash-link" aria-label="Direct link to Config sharing" title="Direct link to Config sharing">â</a></h4><p>We treat every package in monorepo âindependentâ. Thus we can use the standard approach for config sharing, which covers <code>tsconfig</code>, <code>eslintConfig</code>, <code>prettier</code>, <code>stlyelint</code>, and <code>jest-config</code>. See <a href="https://github.com/logto-io/logto/tree/6327eb6c577cdf36c8f44b55bac8195f7d6a6335/packages/console" target="_blank" rel="noopener noreferrer">this project</a> for example.</p><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="code-lint-and-commit">Code, lint, and commit<a href="#code-lint-and-commit" class="hash-link" aria-label="Direct link to Code, lint, and commit" title="Direct link to Code, lint, and commit">â</a></h3><p>I use VSCode for daily development, and in short, nothing is different when the project is configured properly:</p><ul><li>ESLint and Stylelint work normally.<ul><li><p>If you are using VSCode ESLint plugin, add the VSCode settings below to make it honors the per-package ESLint config (replace the value of <code>pattern</code> with your own):</p><div class="language-json codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-json codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;eslint.workingDirectories&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;pattern&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./packages/*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li>husky, commitlint, and lint-staged work as expected.</li></ul><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="compiler-and-proxy">Compiler and proxy<a href="#compiler-and-proxy" class="hash-link" aria-label="Direct link to Compiler and proxy" title="Direct link to Compiler and proxy">â</a></h3><p>We are using different compilers for frontend and backend: <code>parceljs</code> for UI (React) and <code>tsc</code> for all other pure TypeScript packages. I strongly recommend you to try <code>parceljs</code> if you havenât. Itâs a real âzero-configâ compiler that gracefully handles different file types.</p><p>Parcel hosts its own frontend dev server, and the production output is just static files. Since weâd like to mount APIs and SPA under the same origin to avoid CORS issues, the strategy below works:</p><ul><li>In dev environment, use a simple HTTP proxy to redirect the traffic to the Parcel dev server.</li><li>In production, serve static files directly.</li></ul><p>You can find the frontend middleware function implementation <a href="https://github.com/logto-io/logto/blob/6327eb6c577cdf36c8f44b55bac8195f7d6a6335/packages/core/src/middleware/koa-spa-proxy.ts" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="watch-mode">Watch mode<a href="#watch-mode" class="hash-link" aria-label="Direct link to Watch mode" title="Direct link to Watch mode">â</a></h3><p>We have a <code>dev</code> script in <code>package.json</code> for each package that watches the file changes and re-compile when needed. Thanks to <code>lerna</code>, things become easy using <code>lerna exec</code> to run package scripts in parallel. The root script will look like this:</p><div class="language-yaml codeBlockContainer_dUHu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_SC1B"><pre tabindex="0" class="prism-code language-yaml codeBlock_noRx thin-scrollbar"><code class="codeBlockLines_a94C"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">&quot;dev&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;lerna --scope=@logto/{core,phrases,schemas,ui} exec -- pnpm dev&quot;</span><br></span></code></pre><div class="buttonGroup_qENx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_ihXY" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e8Rr"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_iX_b"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_E7Z_" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">â</a></h3><p>Ideally, only two steps for a new engineer/contributor to get started:</p><ol><li>Clone the repo</li><li><code>pnpm i &amp;&amp; pnpm dev</code></li></ol><h2 class="anchor anchorWithStickyNavbar_E7Z_" id="closing-notes">Closing notes<a href="#closing-notes" class="hash-link" aria-label="Direct link to Closing notes" title="Direct link to Closing notes">â</a></h2><p>Our team has been developing under this approach for one year, and we are pretty happy with it. Visit our <a href="https://github.com/logto-io/logto" target="_blank" rel="noopener noreferrer">GitHub repo</a> to see the latest shape of the project. To wrap up:</p><p><strong>Pains</strong></p><ul><li>Need to be familiar with the JS/TS ecosystem</li><li>Need to choose the right package manager</li><li>Require some additional one-time setup</li></ul><p><strong>Gains</strong></p><ul><li>Develop and maintain the whole project in one repo</li><li>Simplified coding skill requirements</li><li>Shared code styles, schemas, phrases, and utilities</li><li>Improved communication efficiency<ul><li>No more questions like: Whatâs the API definition?</li><li>All engineers are talking in the same programming language</li></ul></li><li>CI/CD with ease<ul><li>Use the same toolchain for building, testing, and publishing</li></ul></li></ul><p>This article remains several topics uncovered: Setting up the repo from scratch, adding a new package, leveraging GitHub Actions for CI/CD, etc. Itâll be too long for this article if I expand each of them. Feel free to comment and let me know which topic youâd like to see in the future.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_YC_U"><div class="col"><b>Tags:</b><ul class="tags_HRoz padding--none margin-left--sm"><li class="tag_MJFv"><a class="tag_UdcR tagRegular_8MZA" href="/logto-docs/blog/tags/typescript/">typescript</a></li><li class="tag_MJFv"><a class="tag_UdcR tagRegular_8MZA" href="/logto-docs/blog/tags/monorepo/">monorepo</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/logto-docs/blog/logto-x-hasura/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Logto x Hasura: How to use open-source auth + GraphQL solution to boost your project</div></a></nav></main><div class="col col--2"><div class="tableOfContents_lxxZ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#intro" class="table-of-contents__link toc-highlight">Intro</a></li><li><a href="#why-typescript" class="table-of-contents__link toc-highlight">Why TypeScript?</a></li><li><a href="#choosing-package-manager" class="table-of-contents__link toc-highlight">Choosing package manager</a><ul><li><a href="#the-pain-of-inertia" class="table-of-contents__link toc-highlight">The pain of inertia</a></li><li><a href="#it-just-works" class="table-of-contents__link toc-highlight">It just works</a></li></ul></li><li><a href="#defining-package-scopes" class="table-of-contents__link toc-highlight">Defining package scopes</a></li><li><a href="#tech-stack-for-fullstack" class="table-of-contents__link toc-highlight">Tech stack for fullstack</a><ul><li><a href="#how-about-schemas" class="table-of-contents__link toc-highlight">How about schemas?</a></li><li><a href="#result" class="table-of-contents__link toc-highlight">Result</a></li></ul></li><li><a href="#dev-experience" class="table-of-contents__link toc-highlight">Dev experience</a><ul><li><a href="#package-and-config-sharing" class="table-of-contents__link toc-highlight">Package and config sharing</a></li><li><a href="#code-lint-and-commit" class="table-of-contents__link toc-highlight">Code, lint, and commit</a></li><li><a href="#compiler-and-proxy" class="table-of-contents__link toc-highlight">Compiler and proxy</a></li><li><a href="#watch-mode" class="table-of-contents__link toc-highlight">Watch mode</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#closing-notes" class="table-of-contents__link toc-highlight">Closing notes</a></li></ul></div></div></div></div></div><footer class="footer_TCBS"><div class="container_oxh8"><div class="logoRow_e6WH"><img src="/img/silverhand.svg" alt="Logo"></div><div class="footerRow_MwlS"><div class="copyRight_Do1v">Copyright Â© 2023 Silverhand Inc. Built with Docusaurus.</div><div class="links_lMuC"><a class="footer__link-item" href="/logto-docs/">Docs</a><a href="https://github.com/logto-io/logto" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a><a href="https://logto.io/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Us</a><a href="mailto: contact@logto.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us</a></div></div></div></footer></div>
<script src="/logto-docs/assets/js/runtime~main.cc33f748.js"></script>
<script src="/logto-docs/assets/js/main.777d428a.js"></script>
</body>
</html>